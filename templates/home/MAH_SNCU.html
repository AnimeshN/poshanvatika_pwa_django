{% load static %}
<!DOCTYPE html>
<html>
<head>
    <title>Maharashtra State SNCU GIS MAP</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'static1/leaflet.css' %}" />
    <style>
        #map { height: 100vh; }
        .header {
            background-color: #004d40;
            color: white;
            text-align: center;
            padding: 10px;
            font-size: 24px;
            font-weight: bold;
            letter-spacing: 1.5px;
            box-shadow: 0px 4px 2px -2px gray;
        }

        .info {
            padding: 6px 8px;
            font: 14px/16px Arial, Helvetica, sans-serif;
            background: white;
            background: rgba(255, 255, 255, 0.8);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
            border-radius: 5px;
        }
        .death-label {
            padding: 2px;
            font-size: 12px;
            color: red;
        }
        .pincode-label {
            padding: 2px;
            font-size: 12px;
            color: blue;
        }
        .legend {
            background: white;
            border: 2px solid #000;
            border-radius: 5px;
            padding: 10px;
            font-size: 14px;
            line-height: 18px;
            position: absolute;
            bottom: 70px; /* Adjusted bottom offset */
            right: 10px;
            z-index: 1000;
            width: 200px;
        }

        .legend i {
            width: 18px;
            height: 18px;
            display: inline-block;
            margin-right: 8px;
            border: 2px solid #000;
            border-radius: 50%; /* Make the squares into circles */
            background-color: transparent; /* Add this to ensure proper rendering */
        }
    </style>
</head>
<body>
    <div class="header">
        Maharashtra State SNCU GIS MAP
    </div>
    <div id="map"></div>
    <script src='https://unpkg.com/leaflet@1.9.4/dist/leaflet.js'></script>
    <script>
        // Initialize the map
        var map = L.map('map').setView([19.601, 76.168], 8);

        // Add a base layer
        var osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);
        var mahWms = L.tileLayer.wms('https://geonode.communitygis.in/geoserver/wms', {
            layers: 'geonode:states_in_india',
            format: 'image/png',
            transparent: 'true',
            cql_filter: `state='Maharashtra'`,
        }).addTo(map);
        // Add WMS layer from GeoNode
        var wmsLayer = L.tileLayer.wms('https://geonode.communitygis.in/geoserver/wms', {
            layers: 'geonode:Mah_centroid_percentDeath',
            format: 'image/png',
            transparent: true,
        }).addTo(map);

       // Function to fetch and add legend from GeoNode WMS service
       function addLegendFromWMS() {
            fetch('https://geonode.communitygis.in/geoserver/wms?REQUEST=GetLegendGraphic&VERSION=1.0.0&FORMAT=image/png&WIDTH=20&HEIGHT=20&LAYER=geonode:Mah_centroid_percentDeath')
                .then(response => response.blob())
                .then(blob => {
                    var url = URL.createObjectURL(blob);
                    var legendContainer = L.control({ position: 'bottomright' });
                    
                    legendContainer.onAdd = function () {
                        var div = L.DomUtil.create('div', 'legend');
                        div.innerHTML += `<img src="${url}" alt="Legend">`;
                        return div;
                    };
                    
                    legendContainer.addTo(map);
                })
                .catch(error => console.error('Error fetching WMS legend:', error));
        }

        // Function to fetch and count features in categories from WFS
        function countFeaturesInCategories() {
            var categoryCounts = {
                'white': 0,
                'green': 0,
                'yellow': 0,
                'red': 0,
                'gray': 0
            };

            fetch('https://geonode.communitygis.in/geoserver/wfs?service=WFS&version=1.0.0&request=GetFeature&typeName=geonode:Mah_centroid_percentDeath&outputFormat=application/json')
                .then(response => response.json())
                .then(data => {
                    if (data && data.features) {
                        data.features.forEach(feature => {
                            var deathPer = parseFloat(feature.properties.SNCU_Death).toFixed(2);

                            alert(deathPer)
                            if (isNaN(deathPer) || deathPer === null) {
                                categoryCounts['gray'] += 1;
                            } else if (deathPer > 6.84) {
                                categoryCounts['red'] += 1;
                            } else if (deathPer > 3.65) {
                                categoryCounts['yellow'] += 1;
                            } else if(deathPer > 0.01) {
                                categoryCounts['green'] += 1;
                            } else
                                categoryCounts['white'] +=1;
                        
                        // Create a circle marker for each feature
                    var marker = L.circleMarker([feature.geometry.coordinates[1], feature.geometry.coordinates[0]], {
                        radius: 10,
                        fillColor: isNaN(deathPer) ? '#808080' : deathPer > 6.84 ? '#d31717' : deathPer > 3.65 ? '#e5b009' : deathPer > 0.01 ? '#0b6b1b' : '#FFFFFF',
                        color: "#000",
                        weight: 2,
                        opacity: 1,
                        fillOpacity: 0.8
                    }).addTo(map);

                    // Add hover event to show `SNCU_Death`
                    marker.bindTooltip(`${deathPer}%`, {
                        permanent: false,
                        direction: 'right',
                        className: 'death-label',
                        opacity: 0.8
                    });

                    // Add click event to show `SNCU_Death`, `pincode`, and `address`
                    marker.on('click', function(e) {
                        var popupContent = `
                            <div>
                                <b>Death Percentage:</b> ${deathPer}%<br>
                                <b>Name:</b> ${feature.properties.unit_name || 'Unknown'}<br>
                                <b>Address:</b> ${feature.properties.Adress || 'Unknown'}
                            </div>
                        `;
                        L.popup()
                            .setLatLng(e.latlng)
                            .setContent(popupContent)
                            .openOn(map);
                    });
                });

                        // Update the legend with category counts
                        var legend = L.control({ position: 'bottomright' });

                        legend.onAdd = function () {
                            var div = L.DomUtil.create('div', 'legend');
                            div.innerHTML = `
                                <div><b>Death Percentage Legend</b></div>
                                <div><i style="background: #FFFFFF"></i> 0 (${categoryCounts['white']})</div>
                                <div><i style="background: #0b6b1b"></i> 0.01% - 3.65% (${categoryCounts['green']})</div>
                                <div><i style="background: #e5b009"></i> 3.66 - 6.83 (${categoryCounts['yellow']})</div>
                                <div><i style="background: #d31717"></i> 6.84 - 15.27 (${categoryCounts['red']})</div>
                                <div><i style="background: #808080"></i> NaN (${categoryCounts['gray']})</div>
                            `;
                            return div;
                        };

                        legend.addTo(map);
                    } else {
                        console.error('Invalid GeoJSON data for features.');
                    }
                })
                .catch(error => console.error('Error fetching WFS data:', error));
        }

        // // Add the WMS legend to the map
        // addLegendFromWMS();

        // Count features in categories and update the legend
        countFeaturesInCategories();
    </script>
</body>
</html>