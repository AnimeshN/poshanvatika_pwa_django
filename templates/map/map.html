{% extends 'map/base_map.html'%}
{% load static %}
{% block extra_resources%}
<style>

.popupimage {
    height: 200px;
    width: 300px;
    overflow: hidden;
    border-radius: 50px;
}

#content{
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
}
</style>
{% endblock %}

{% block map %}
<div id="mapid" style="width: 100%; height: 100%;"></div>

  <!-- Modal Structure -->
  <div id="demo-modal" class="modal bottom-sheet"> 
    <div id="content" class="modal-content"> 
    </div> 
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a>
      </div>
</div> 
<script>

    var mymap = L.map('mapid').setView([19.7515-1,75.7139-1], 7);
    
    var mbAttr = 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
			'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
		mbUrl = 'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';

	var grayscale   = L.tileLayer(mbUrl, {id: 'mapbox/light-v9', tileSize: 512, zoomOffset: -1, attribution: mbAttr}),
        streets  = L.tileLayer(mbUrl, {id: 'mapbox/streets-v11', tileSize: 512, zoomOffset: -1, attribution: mbAttr});
        
    // const url = 'https://makerghat.urbansciences.in/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&outputFormat=json&typename=geonode:diet_data8jan';
    const url ='https://makerghat.urbansciences.in/geoserver/ows?service=WFS&version=1.0.0&request=GetFeature&typename=geonode%3Adiet_data8jan0&outputFormat=json&srs=EPSG%3A4326&srsName=EPSG%3A4326&access_token=O6oEuBsGns96o82uipTF2Lht11d8tb';
	L.tileLayer('https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
		maxZoom: 18,
		attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, ' +
			'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
		id: 'mapbox/streets-v11',
		tileSize: 512,
		zoomOffset: -1
    }).addTo(mymap);
    
    var baseLayers = {
		"Grayscale": grayscale,
		"Streets": streets
    };
    let indiaState = L.tileLayer.wms("https://makerghat.urbansciences.in/geoserver/wms", {
            layers: "geonode:states_in_india",
            format: "image/png",
            transparent: "true",
            tiled: "true",
            opacity: 0.7,
            }
        );
    let indiaDistrict = L.tileLayer.wms("https://makerghat.urbansciences.in/geoserver/wms", {
        layers: "geonode:all_india_districts_11june2020",
        format: "image/png",
        transparent: "true",
        tiled: "true",
        opacity: 0.7,
        }
    );

    let mahaHighways = L.tileLayer.wms("https://makerghat.urbansciences.in/geoserver/wms", {
        layers: "geonode:osm_highways",
        format: "image/png",
        transparent: "true",
        tiled: "true",
        opacity: 0.7,
        }
    );

    let mahaSchools = L.tileLayer.wms("https://makerghat.urbansciences.in/geoserver/wms", {
        layers: "geonode:school_16_17_11april",
        format: "image/png",
        transparent: "true",
        tiled: "true",
        opacity: 0.7,
        }
    );

	var overlays = {
        "States":indiaState,
        "Districts":indiaDistrict,
        "Maharashtra Highways":mahaHighways,
        "Maharashtra Schools":mahaSchools
	};

	L.control.layers(baseLayers, overlays).addTo(mymap);

    var pvIcon = L.icon({
            iconUrl: "{% static 'map/images/pw_logo.png' %}",
            iconSize:     [50, 60], // size of the icon
            //shadowSize:   [50, 64], // size of the shadow
            iconAnchor:   [25,10], // point of the icon which will correspond to marker's location
            // shadowAnchor: [4, 62],  // the same for the shadow
            popupAnchor:  [0, 0] // point from which the popup should open relative to the iconAnchor
        });

    var geojsonMarkerOptions11 = {
                    radius: 8,
                    fillColor: "#8975fa",
                    color: "#000",
                    weight: 1,
                    opacity: 1,
                    fillOpacity: 0.8
                };

    const onEachFeatureForPoint = (feature, layer) =>{
        var str1 = " <img class = 'popupimage' src='/static/map/".concat(feature.properties.image);
        var str2 = str1.concat("' alt='image not found'>");
                        // layer.bindPopup(str2);

        const table = `
        <table class='striped centered'>
        <thead>
          <tr>
              <th>Village Name</th>
              <th>${feature.properties.village}</th>
          </tr>
        </thead>

        <tbody>
          <tr>
            <td>Block</td>
            <td>${feature.properties.block}</td>
          </tr>

          <tr>
            <td>District</td>
            <td>${feature.properties.district}</td>
          </tr>

          <tr>
            <td>CFNS</td>
            <td>${feature.properties.CFNS}</td>
          </tr>

          <tr>
            <td>Utilization</td>
            <td>${feature.properties.Utility}</td>
          </tr>

          <tr>
            <td>Water Source</td>
            <td>${feature.properties.WaterSrc}</td>
          </tr>

          <tr>
            <td>Crop Pattern</td>
            <td>${feature.properties.croppatten}</td>
          </tr>

        </tbody>
      </table>
      `
        layer.on("click",e => {
            document.getElementById("content").innerHTML = str2 + table;
            var elem = document.getElementById('demo-modal');
            var instance = M.Modal.getInstance(elem);
            instance.open();

        })
    }

    fetch(url).then(res => {
        res.json().then(
            function(geojsonData) {
                poshanvatika = L.geoJson(geojsonData.features, {
                pointToLayer: function(feature, latlng) {
                        return L.marker(latlng, {icon:pvIcon});
                },
                onEachFeature: onEachFeatureForPoint,
            }).addTo(mymap);
        })
    });

</script>
<script>

document.addEventListener('DOMContentLoaded', () => {
    var elems = document.querySelectorAll('.modal');
    var instances = M.Modal.init(elems, {opacity:.3});
});

</script>
{% endblock map%}
